{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/anthropics/mz-explode/corkami_test_spec_schema.json",
  "title": "Corkami PE Test Specification Schema",
  "description": "Schema for Corkami PE test corpus specifications",
  "type": "object",
  "required": ["title", "version", "corpus_path", "test_files"],
  "properties": {
    "$schema": {
      "type": "string"
    },
    "title": {
      "type": "string"
    },
    "description": {
      "type": "string"
    },
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "corpus_path": {
      "type": "string",
      "description": "Path to Corkami PE corpus bin directory"
    },
    "test_files": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/test_file"
      }
    },
    "test_categories_index": {
      "type": "object",
      "additionalProperties": {
        "type": "array",
        "items": {"type": "string"}
      }
    },
    "field_coverage": {
      "type": "object",
      "description": "Index of which files test which fields"
    }
  },
  "definitions": {
    "test_file": {
      "type": "object",
      "required": ["binary_file", "asm_source", "description", "test_categories"],
      "properties": {
        "binary_file": {
          "type": "string",
          "description": "Name of the compiled PE file"
        },
        "asm_source": {
          "type": "string",
          "description": "Name of the ASM source file"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of what this file tests"
        },
        "test_categories": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Categories this test belongs to"
        },
        "data_directories": {
          "type": "object",
          "properties": {
            "IMPORT": {"$ref": "#/definitions/import_directory"},
            "EXPORT": {"$ref": "#/definitions/export_directory"},
            "TLS": {"$ref": "#/definitions/tls_directory"},
            "DEBUG": {"$ref": "#/definitions/debug_directory"},
            "SECURITY": {"$ref": "#/definitions/security_directory"},
            "COM_DESCRIPTOR": {"$ref": "#/definitions/com_descriptor"},
            "DELAY_IMPORT": {"$ref": "#/definitions/delay_import_directory"},
            "BASERELOC": {"$ref": "#/definitions/relocation_directory"},
            "BOUND_IMPORT": {"$ref": "#/definitions/bound_import_directory"},
            "LOAD_CONFIG": {"$ref": "#/definitions/load_config_directory"},
            "RESOURCE": {"$ref": "#/definitions/resource_directory"}
          }
        },
        "pe_header": {
          "$ref": "#/definitions/pe_header"
        }
      }
    },
    "import_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "dll_count": {"type": "integer", "minimum": 0},
        "dlls": {
          "type": "array",
          "items": {"$ref": "#/definitions/imported_dll"}
        },
        "comment": {"type": "string"}
      }
    },
    "imported_dll": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {"type": "string"},
        "name_case_sensitive": {"type": "boolean", "default": false},
        "function_count": {"type": "integer", "minimum": 0},
        "functions": {
          "type": "array",
          "items": {"$ref": "#/definitions/imported_function"}
        }
      }
    },
    "imported_function": {
      "type": "object",
      "properties": {
        "name": {"type": ["string", "null"]},
        "is_ordinal": {"type": "boolean"},
        "ordinal": {"type": "integer"},
        "hint": {"type": "integer"},
        "comment": {"type": "string"}
      }
    },
    "export_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "module_name": {"type": "string"},
        "export_count": {"type": "integer", "minimum": 0},
        "exports": {
          "type": "array",
          "items": {"$ref": "#/definitions/exported_function"}
        },
        "comment": {"type": "string"}
      }
    },
    "exported_function": {
      "type": "object",
      "properties": {
        "name": {"type": ["string", "null"]},
        "ordinal": {"type": "integer"},
        "has_name": {"type": "boolean"},
        "is_forwarder": {"type": "boolean"},
        "comment": {"type": "string"}
      }
    },
    "tls_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "callback_count": {"type": "integer", "minimum": 0},
        "tls_index": {"type": "string"},
        "address_of_index_nonzero": {"type": "boolean"},
        "address_of_callbacks_nonzero": {"type": "boolean"},
        "has_callbacks": {"type": "boolean"},
        "comment": {"type": "string"}
      }
    },
    "debug_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "entry_count": {"type": "integer", "minimum": 0},
        "entries": {
          "type": "array",
          "items": {"$ref": "#/definitions/debug_entry"}
        },
        "comment": {"type": "string"}
      }
    },
    "debug_entry": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {"type": "string"},
        "type_value": {"type": "integer"},
        "size_of_data": {"type": "integer"},
        "codeview": {"$ref": "#/definitions/codeview_info"},
        "comment": {"type": "string"}
      }
    },
    "codeview_info": {
      "type": "object",
      "properties": {
        "signature": {"type": "string"},
        "guid": {"type": "string"},
        "age": {"type": "integer"},
        "age_hex": {"type": "string"},
        "pdb_path": {"type": "string"}
      }
    },
    "security_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "certificate_count": {"type": "integer", "minimum": 0},
        "certificates": {
          "type": "array",
          "items": {"$ref": "#/definitions/certificate"}
        },
        "comment": {"type": "string"}
      }
    },
    "certificate": {
      "type": "object",
      "properties": {
        "revision": {"type": "string"},
        "type": {"type": "string"},
        "type_value": {"type": "integer"},
        "data_size": {"type": "integer"},
        "is_authenticode": {"type": "boolean"},
        "comment": {"type": "string"}
      }
    },
    "com_descriptor": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "is_valid": {"type": "boolean"},
        "runtime_version": {"type": "string"},
        "major_version": {"type": "integer"},
        "minor_version": {"type": "integer"},
        "metadata_rva_nonzero": {"type": "boolean"},
        "metadata_size_nonzero": {"type": "boolean"},
        "flags": {"type": "object"},
        "metadata": {"type": "object"},
        "comment": {"type": "string"}
      }
    },
    "delay_import_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "dll_count": {"type": "integer", "minimum": 0},
        "dlls": {
          "type": "array",
          "items": {"$ref": "#/definitions/imported_dll"}
        },
        "comment": {"type": "string"}
      }
    },
    "relocation_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "block_count": {"type": "integer", "minimum": 0},
        "total_relocations": {"type": "integer"},
        "relocation_type": {"type": "string"},
        "blocks": {
          "type": "array",
          "items": {"$ref": "#/definitions/relocation_block"}
        },
        "comment": {"type": "string"}
      }
    },
    "relocation_block": {
      "type": "object",
      "properties": {
        "page_rva": {"type": "string"},
        "relocation_count": {"type": "integer"},
        "type": {"type": "string"},
        "comment": {"type": "string"}
      }
    },
    "bound_import_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "descriptor_count": {"type": "integer", "minimum": 0},
        "comment": {"type": "string"}
      }
    },
    "load_config_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "is_empty": {"type": "boolean"},
        "has_security_cookie": {"type": "boolean"},
        "has_cfg": {"type": "boolean"},
        "comment": {"type": "string"}
      }
    },
    "resource_directory": {
      "type": "object",
      "required": ["present"],
      "properties": {
        "present": {"type": "boolean"},
        "comment": {"type": "string"}
      }
    },
    "pe_header": {
      "type": "object",
      "properties": {
        "imagebase": {"type": "string"},
        "imagebase_comment": {"type": "string"},
        "section_alignment": {"type": "string"},
        "file_alignment": {"type": "string"},
        "alignment_comment": {"type": "string"},
        "subsystem": {"type": "string"},
        "section_count": {"type": "integer"},
        "sections": {
          "type": "array",
          "items": {"type": "string"}
        },
        "is_dll": {"type": "boolean"},
        "is_64bit": {"type": "boolean"},
        "magic": {"type": "string"},
        "characteristics": {"type": "object"},
        "linker_version": {"type": "object"},
        "comment": {"type": "string"}
      }
    }
  }
}
